From 7a11e7338a8f76b19b3011649e097571cb0fe1bf Mon Sep 17 00:00:00 2001
From: Sudip Mukherjee <sudip.mukherjee@codethink.co.uk>
Date: Thu, 26 Nov 2020 14:31:34 +0000
Subject: [PATCH] Send can signals

Signed-off-by: Sudip Mukherjee <sudip.mukherjee@codethink.co.uk>
---
 Safety-signal-source.c | 12 +++++++++---
 safety-app.c           |  2 +-
 2 files changed, 10 insertions(+), 4 deletions(-)

diff --git a/Safety-signal-source.c b/Safety-signal-source.c
index 72955f7..271ddea 100644
--- a/Safety-signal-source.c
+++ b/Safety-signal-source.c
@@ -13,6 +13,7 @@ int main()
     const char* Pipe="/tmp/safety-signal-source_to_safety-app";
     mkfifo(Pipe,0666);
     int fd=open(Pipe, O_WRONLY);
+    unsigned char fault = 0;
 
     // Message counter and Buffer for Message to be sent
     unsigned int MC=0;
@@ -47,7 +48,8 @@ int main()
         // wrong checksum test "1" corresponds to ASCII 49
         if (Controlmessage[0] == 49)
         {
-            Controlmessage[0] == 10;
+            Controlmessage[0] = 10;
+            fault = 1;
             Message[5]=random();
         }        
 
@@ -58,11 +60,15 @@ int main()
         // skip message test "2" corresponds to ASCII 50
         if (Controlmessage[0] == 50)
         {
-            Controlmessage[0] == 10;
+            Controlmessage[0] = 10;
         }
         else
         {
             write(fd,Message,6);
+            if (fault == 1) {
+                fault = 0;
+                system("cansend can0 021#0000000002000000");
+            }
         }
         
         MC+=1;
@@ -73,4 +79,4 @@ int main()
 
 
 return 0;
-}
\ No newline at end of file
+}
diff --git a/safety-app.c b/safety-app.c
index 16bf087..71ae013 100644
--- a/safety-app.c
+++ b/safety-app.c
@@ -77,7 +77,7 @@ while (1) {
             // could just kill the qt app to get the safe state black screen 
             // killall afbd-cluster-gauges 
             // does the trick from the shell, lets try to do that from here yep, works
-             system("killall afbd-cluster-gauges");
+             system("cansend can0 021#0000000000000080");
         }
     }
     int sleeptime=1000000;
-- 
2.20.1

